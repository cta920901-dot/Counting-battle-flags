<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸æˆ°æ£‹ï¼šè²“å’ªå¤§æˆ°çˆ­ | Math Cat Battle</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Zen+Maru+Gothic:wght@500;700&family=Chakra+Petch:wght@500;700&display=swap" rel="stylesheet">

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: 'Zen Maru Gothic', 'Noto Serif TC', serif;
            background-color: #e6f2ff; 
            color: #4a4a4a;
            overflow-x: hidden;
        }

        /* Japanese Style Subtle Pattern Background */
        .bg-japanese-pattern {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -2;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='20' viewBox='0 0 100 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M21.184 20c.357-.13.72-.264 1.088-.402l1.768-.661C33.64 15.347 39.647 14 50 14c10.271 0 15.362 1.222 24.629 4.928.955.383 1.869.74 2.75 1.072h6.225c-2.51-.735-5.197-1.52-8.144-2.52-3.262-1.107-6.256-2.172-9.65-3.342-8.14-2.816-15.36-5.316-26.16-5.316-11.057 0-17.222 2.566-24.623 5.138-3.556 1.235-6.95 2.378-10.48 3.578l-1.557.53c-3.022 1.026-5.91 1.987-8.795 2.932h7.803zm-6.132-5.786c-3.656-1.307-7.208-2.548-11.023-3.85-7.186-2.448-12.99-4.437-20.409-4.437-7.204 0-13.337 2.155-20.96 4.935-3.586 1.309-7.22 2.618-10.725 3.89V8.507c4.468-1.75 9.223-3.507 14.443-5.25C12.774 1.004 21.022 0 29.629 0c8.685 0 16.187.986 22.673 3.158 4.297 1.438 8.39 2.92 12.28 4.39L67.47 8.63c-4.046-1.625-8.607-3.28-13.75-4.872C47.14 1.495 39.423 0 30.943 0c-8.625 0-15.562 1.35-21.532 3.57C4.698 5.325 0 6.814 0 6.814v4.39c2.21-1.04 4.517-1.996 7.143-2.96 6.748-2.485 13.73-4.948 23.704-4.948 9.73 0 15.995 2.42 23.54 5.132 3.37 1.212 6.706 2.406 9.793 3.57h-8.892c-2.165-.763-4.262-1.5-6.57-2.296-7.593-2.617-13.86-4.778-23.358-4.778-9.317 0-15.316 2.14-22.72 4.704-3.84 1.332-7.672 2.672-11.378 3.975.508.176 1.016.35 1.522.523 1.126.387 2.256.773 3.39 1.157l.193.065zm15.307-1.97c6.533-2.178 12.01-3.73 18.16-3.73 6.62 0 11.953 1.95 18.117 4.333l.002.002c2.425.938 4.867 1.886 7.524 2.856h-8.476c-2.07-.745-4.066-1.474-6.27-2.244-7.106-2.488-12.976-4.545-21.862-4.545-9.113 0-15.14 2.105-22.517 4.613-3.964 1.35-7.93 2.702-11.756 4.01L15.242 20h7.902c.32-.116.643-.233.97-.35l.052-.017c.69-.25 1.38-.5 2.08-.75.537-.192 1.075-.384 1.616-.576l.052-.018c3.305-1.177 6.714-2.383 10.48-3.69 7.4-2.572 13.564-5.138 24.622-5.138 10.802 0 18.02 2.5 26.16 5.316 3.393 1.17 6.387 2.235 9.65 3.342l.564.19v-4.102l-1.37-.5c-3.41-1.247-6.758-2.492-9.916-3.71C61.924 7.81 55.932 6.57 46.947 6.57c-9.154 0-15.164 1.183-22.263 3.52l-.002.002c-2.282.75-4.455 1.452-6.798 2.25-7.06 2.403-12.726 4.23-20.337 4.23-7.445 0-12.816-1.648-19.163-3.692C4.816 12.068 0 11.12 0 11.12v3.65c1.568.528 3.542 1.14 5.798 1.816 7.276 2.185 13.103 3.935 20.57 3.935 8.227 0 15.14-2.284 22.518-4.85l.055-.02c.535-.185 1.07-.37 1.61-.555l.056-.02c.686-.236 1.37-.47 2.06-.708l.053-.018c3.835-1.31 7.792-2.65 11.85-3.97 7.228-2.345 13.106-4.372 21.144-4.372 8.226 0 15.138 2.284 22.516 4.848 3.97 1.346 7.89 2.692 11.706 4.014v-3.942l-1.734-.604c-3.615-1.25-7.13-2.455-10.668-3.653-7.527-2.54-13.563-4.575-21.822-4.575-8.02 0-13.385 1.647-19.633 3.627-4.175 1.32-8.85 2.744-14.038 4.422C23.267 15.603 14.98 16.5 6.71 16.5c-5.813 0-10.63-.434-14.66-1.295l.006 4.05c4.32.82 9.687 1.222 15.83 1.222 8.016 0 15.922-.87 23.63-3.364 4.838-1.562 9.162-2.872 13.767-4.158l.256-.072.006-.002c7.858-2.183 14.163-3.844 21.202-3.844 7.856 0 14.16 1.662 22.018 3.844 2.185.605 4.492 1.236 6.86 1.934v-3.78c-3.056-1.02-6.256-2.09-9.67-3.223C78.626 5.828 71.85 3.87 63.83 3.87c-7.88 0-13.942 1.87-21.097 4.142-2.295.728-4.627 1.46-7.046 2.228l-.212.065c-8.505 2.666-15.196 4.695-23.756 4.695-7.857 0-14.162-1.662-22.02-3.844l-.5-.14v3.795c3.612 1.245 7.127 2.45 10.666 3.648C17.405 21 23.443 23.036 31.703 23.036c7.877 0 13.938-1.87 21.092-4.14 2.294-.728 4.626-1.46 7.045-2.226l.213-.067c8.506-2.665 15.197-4.695 23.756-4.695 7.86 0 14.163 1.662 22.02 3.844 4.455 1.236 8.848 2.51 13.175 3.845v-3.625c-5.19-1.554-10.475-3.07-15.92-4.83-7.704-2.49-13.99-4.473-22.018-4.473-8.03 0-14.317 1.983-22.02 4.475-4.366 1.41-8.618 2.652-12.84 3.862V20z' fill='%23c4e0f5' fill-opacity='0.4' fill-rule='evenodd'/%3E%3C/svg%3E");
            background-size: 100px 20px;
            opacity: 0.6;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 4px;
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in-pop {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .wood-texture {
            background: #e6c698;
            position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        .wood-texture::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(45deg, rgba(255,255,255,0.1) 0px, rgba(0,0,0,0.05) 2px, rgba(255,255,255,0.1) 4px);
            pointer-events: none;
            border-radius: 0.5rem;
        }
        
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }

        .digital-font {
            font-family: 'Chakra Petch', monospace;
        }
    </style>
</head>
<body>
    <div class="bg-japanese-pattern"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Constants
        const COLS = 10;
        const ROWS = 10;
        const INITIAL_TIME = 300; // 5 minutes in seconds
        const MAX_FOULS = 5;
        const PIECE_VALUES = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];

        // --- SVG Icons Components ---
        const PawIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path d="M12 2a3 3 0 0 1 3 3 3 3 0 0 1-3 3 3 3 0 0 1-3-3 3 3 0 0 1 3-3m5 4.5a2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5 2.5 2.5 0 0 1-2.5-2.5M7 6.5a2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5 2.5 2.5 0 0 1-2.5-2.5A2.5 2.5 0 0 1 7 6.5M12 10a5 5 0 0 1 5 5v2a3 3 0 0 1-3 3H10a3 3 0 0 1-3-3v-2a5 5 0 0 1 5-5z"/>
            </svg>
        );

        const BookIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            </svg>
        );

        const TrophyIcon = ({ className }) => (
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path fillRule="evenodd" d="M5.166 2.621v.858c-1.035.148-2.059.33-3.071.543a.75.75 0 00-.584.859 6.753 6.753 0 006.138 5.6 6.73 6.73 0 002.743 1.346A6.707 6.707 0 019.279 15H8.54c-1.036 0-1.875.84-1.875 1.875V19.5h-.75a2.25 2.25 0 00-2.25 2.25c0 .414.336.75.75.75h15a.75.75 0 00.75-.75 2.25 2.25 0 00-2.25-2.25h-.75v-2.625c0-1.036-.84-1.875-1.875-1.875h-.739a6.706 6.706 0 01-1.112-3.173 6.73 6.73 0 002.743-1.347 6.753 6.753 0 006.139-5.6.75.75 0 00-.585-.858 47.76 47.76 0 00-3.07-.543V2.62a.75.75 0 00-.658-.744 49.22 49.22 0 00-6.093-.377c-2.063 0-4.096.128-6.093.377a.75.75 0 00-.657.744zm0 2.329a5.231 5.231 0 011.042.64 6.739 6.739 0 00-.691.512c-.375.309-.714.653-1.013 1.026a5.254 5.254 0 01.662-2.178zm10.892.64a5.23 5.23 0 011.042-.64 5.254 5.254 0 01.662 2.178c-.299-.373-.638-.717-1.013-1.026a6.739 6.739 0 00-.691-.512z" clipRule="evenodd" />
            </svg>
        );

        const ClockIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10" />
                <polyline points="12 6 12 12 16 14" />
            </svg>
        );

        const AlertIcon = ({ className }) => (
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
        );

        const SwapIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l5 5M4 4l5 5"/>
            </svg>
        );

        const PauseIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="currentColor" className={className}>
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
        );

        const PlayIcon = ({ className }) => (
            <svg viewBox="0 0 24 24" fill="currentColor" className={className}>
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
        );

        // --- Custom Cat Piece SVG Shape ---
        const CatPieceSVG = ({ colorClass, strokeClass }) => (
            <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-md">
                <path 
                    d="M 20 35 
                       Q 15 5 40 20 
                       Q 50 15 60 20 
                       Q 85 5 80 35 
                       A 45 42 0 1 1 20 35 Z" 
                    className={colorClass} 
                    stroke={strokeClass ? "currentColor" : "none"}
                    strokeWidth="3"
                />
            </svg>
        );

        // --- Name Input Modal (Outside) ---
        const NameInputModal = ({ whiteName, setWhiteName, blackName, setBlackName, onConfirm }) => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-blue-100/90 backdrop-blur-sm p-4 animate-fade-in-pop">
                <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl border-4 border-blue-200 relative overflow-hidden">
                    <div className="absolute -top-10 -right-10 w-32 h-32 bg-yellow-100 rounded-full"></div>
                    <div className="absolute -bottom-10 -left-10 w-24 h-24 bg-blue-100 rounded-full"></div>
                    
                    <div className="relative z-10 text-center">
                        <div className="text-6xl mb-4">ğŸ± VS ğŸ˜¼</div>
                        <h2 className="text-3xl font-bold text-stone-800 mb-2 font-serif">é¸æ‰‹ç™»éŒ„</h2>
                        <p className="text-stone-500 mb-8">å…©å›åˆæ”»å®ˆäº¤æ›åˆ¶ï¼Œç¸½å‹å ´å¤šè€…å‹ï¼</p>
                        
                        <div className="space-y-6">
                            <div className="text-left">
                                <label className="block text-sm font-bold text-stone-600 mb-2 ml-1">âšª ç™½è²“é¸æ‰‹ (å…ˆæ‰‹)</label>
                                <input 
                                    type="text" 
                                    value={whiteName}
                                    onChange={(e) => setWhiteName(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl border-2 border-stone-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-200 outline-none transition-all text-lg font-bold text-stone-700 bg-stone-50"
                                    placeholder="è«‹è¼¸å…¥åå­—..."
                                />
                            </div>
                            
                            <div className="text-left">
                                <label className="block text-sm font-bold text-stone-600 mb-2 ml-1">âš« é»‘è²“é¸æ‰‹ (å¾Œæ‰‹)</label>
                                <input 
                                    type="text" 
                                    value={blackName}
                                    onChange={(e) => setBlackName(e.target.value)}
                                    className="w-full px-4 py-3 rounded-xl border-2 border-stone-200 focus:border-stone-500 focus:ring-2 focus:ring-stone-200 outline-none transition-all text-lg font-bold text-stone-700 bg-stone-50"
                                    placeholder="è«‹è¼¸å…¥åå­—..."
                                />
                            </div>

                            <button 
                                onClick={() => {
                                    if(whiteName.trim() && blackName.trim()){
                                        onConfirm();
                                    }
                                }}
                                className="w-full py-4 bg-gradient-to-r from-blue-400 to-indigo-400 hover:from-blue-500 hover:to-indigo-500 text-white rounded-xl font-bold shadow-lg transform transition-transform active:scale-95 text-xl mt-4"
                            >
                                é–‹å§‹å°æˆ°ï¼ ğŸš€
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );

        // --- Rules Modal ---
        const RulesModal = ({ onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 modal-backdrop p-4" onClick={onClose}>
                <div className="bg-white rounded-2xl w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl overflow-hidden relative" onClick={e => e.stopPropagation()}>
                    <div className="bg-blue-400 p-4 flex items-center justify-between text-white">
                        <h2 className="text-2xl font-bold flex items-center gap-2">
                            <BookIcon className="w-6 h-6"/> éŠæˆ²è¦å‰‡æ‰‹å†Š
                        </h2>
                        <button onClick={onClose} className="hover:bg-blue-500 p-1 rounded-full text-2xl leading-none">&times;</button>
                    </div>
                    <div className="p-6 overflow-y-auto space-y-6 text-stone-700">
                        <section>
                            <h3 className="text-lg font-bold text-blue-600 mb-2 border-b-2 border-blue-200 pb-1 flex items-center gap-2"><span className="bg-blue-100 p-1 rounded">1</span> æ”»å®ˆäº¤æ›åˆ¶ (BO2)</h3>
                            <p className="leading-relaxed bg-blue-50 p-3 rounded-lg border border-blue-200">
                                ç‚ºäº†å…¬å¹³èµ·è¦‹ï¼ŒéŠæˆ²åˆ†ç‚º<b>å…©å›åˆ</b>ã€‚<br/>
                                ç¬¬ 1 å›åˆçµæŸå¾Œï¼Œé›™æ–¹<b>äº¤æ›é¡è‰²</b>ï¼ˆå…ˆæ‰‹è®Šå¾Œæ‰‹ï¼‰å†æˆ°ä¸€å±€ã€‚<br/>
                                æœ€çµ‚ä¾æ“šå…©å›åˆçš„ç¸½å‹å ´æ•¸æ±ºå®šå† è»ï¼
                            </p>
                        </section>
                        <section>
                            <h3 className="text-lg font-bold text-blue-600 mb-2 border-b-2 border-blue-200 pb-1 flex items-center gap-2"><span className="bg-blue-100 p-1 rounded">2</span> æ™‚é–“èˆ‡çµç®—</h3>
                             <ul className="list-disc pl-5 space-y-2">
                                <li className="bg-yellow-50 p-2 rounded border border-yellow-200"><b>é™æ™‚ 5 åˆ†é˜ï¼š</b>æ™‚é–“æ­¸é›¶æ™‚è©²å›åˆç«‹å³çµæŸã€‚</li>
                                <li className="bg-stone-50 p-2 rounded border border-stone-200">
                                    <b>è¶…æ™‚çµç®—ï¼š</b>å¦‚æœæ™‚é–“åˆ°ï¼Œæ¯”è¼ƒ<b>ã€Œåƒæ‰çš„æ£‹å­æ•¸é‡ã€</b>å¤šè€…ç²å‹ã€‚
                                    <span className="text-xs text-stone-500 block">è‹¥æ•¸é‡ç›¸åŒï¼Œæ¯”è¼ƒèª°åƒæ‰çš„æ£‹å­åŒ…å«æ›´å°çš„æ•¸å­—ã€‚</span>
                                </li>
                                <li className="bg-red-50 p-2 rounded border border-red-200"><b>çŠ¯è¦ä¸Šé™ï¼š</b>çŠ¯è¦ 5 æ¬¡ç›´æ¥è©²å±€åˆ¤è¼¸ã€‚</li>
                            </ul>
                        </section>
                        <section>
                            <h3 className="text-lg font-bold text-blue-600 mb-2 border-b-2 border-blue-200 pb-1 flex items-center gap-2"><span className="bg-blue-100 p-1 rounded">3</span> ç§»å‹•è¦å‰‡</h3>
                            <ul className="list-disc pl-5 space-y-2">
                                <li><b>æ–¹å‘ï¼š</b>ç™½è²“ 1â†’100ï¼Œé»‘è²“ 100â†’1ã€‚</li>
                                <li><b>æ•´é™¤ï¼š</b>æ ¼å­æ•¸å­—å¿…é ˆèƒ½è¢«æ£‹å­æ•¸å­—æ•´é™¤ã€‚</li>
                                <li><b>å‡ç´šï¼š</b>æŠµé”åº•ç·šè®Šèº«ï¼å¯å¾Œé€€ä¸”ç„¡è¦–æ•´é™¤ã€‚</li>
                            </ul>
                        </section>
                    </div>
                    <div className="bg-gray-50 p-4 border-t flex justify-end">
                        <button onClick={onClose} className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-full font-bold transition-colors shadow-lg">æˆ‘æ‡‚äº†ï¼Œé–‹å§‹æˆ°é¬¥ï¼ ğŸ˜¼</button>
                    </div>
                </div>
            </div>
        );

        // --- Logic ---
        const generateInitialState = () => {
            const whiteStart = [1,2,3,4,5,6,7,8,9,10].sort(() => Math.random() - 0.5);
            const blackStart = [1,2,3,4,5,6,7,8,9,10].sort(() => Math.random() - 0.5);
            
            const pieces = [];
            whiteStart.forEach((val, idx) => {
                pieces.push({ id: `w-${val}`, player: 'white', value: val, position: idx, isUpgraded: false });
            });
            blackStart.forEach((val, idx) => {
                pieces.push({ id: `b-${val}`, player: 'black', value: val, position: 90 + idx, isUpgraded: false });
            });
            return pieces;
        };

        const formatTime = (seconds) => {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        };

        const App = () => {
            // Game State
            const [pieces, setPieces] = useState([]);
            const [turn, setTurn] = useState('white');
            const [selectedPieceId, setSelectedPieceId] = useState(null);
            const [isPaused, setIsPaused] = useState(false);
            
            // Round & Match State
            const [round, setRound] = useState(1);
            const [roundWinner, setRoundWinner] = useState(null);
            const [matchOver, setMatchOver] = useState(false);
            
            const [winReason, setWinReason] = useState("");
            const [history, setHistory] = useState([]);
            const [errorMsg, setErrorMsg] = useState(null);
            const [showRules, setShowRules] = useState(false);
            
            // Persistent Player Names
            const [p1Name, setP1Name] = useState(""); 
            const [p2Name, setP2Name] = useState("");
            const [isNameSet, setIsNameSet] = useState(false);

            // Win Stats
            const [playerWins, setPlayerWins] = useState({ p1: 0, p2: 0 });

            // Time & Fouls
            const [times, setTimes] = useState({ white: INITIAL_TIME, black: INITIAL_TIME });
            const [fouls, setFouls] = useState({ white: 0, black: 0 });

            const errorTimeoutRef = useRef(null);
            const timerRef = useRef(null);
            const piecesRef = useRef(pieces);

            useEffect(() => {
                piecesRef.current = pieces;
            }, [pieces]);

            // Initial Start
            useEffect(() => {
                if (isNameSet) {
                    startRound();
                }
                return () => {
                    if (errorTimeoutRef.current) clearTimeout(errorTimeoutRef.current);
                    if (timerRef.current) clearInterval(timerRef.current);
                };
            }, [isNameSet]);

            // Timer Logic
            useEffect(() => {
                if (!isNameSet || roundWinner || matchOver || errorMsg || showRules || isPaused) {
                    if (timerRef.current) clearInterval(timerRef.current);
                    return;
                }

                timerRef.current = setInterval(() => {
                    setTimes(prevTimes => {
                        const newTime = prevTimes[turn] - 1;
                        if (newTime <= 0) {
                            clearInterval(timerRef.current);
                            handleTimeOut();
                            return { ...prevTimes, [turn]: 0 };
                        }
                        return { ...prevTimes, [turn]: newTime };
                    });
                }, 1000);

                return () => clearInterval(timerRef.current);
            }, [turn, isNameSet, roundWinner, matchOver, errorMsg, showRules, isPaused]);

            const startRound = () => {
                setPieces(generateInitialState());
                setTurn('white');
                setSelectedPieceId(null);
                setRoundWinner(null);
                setWinReason("");
                setHistory([]);
                setErrorMsg(null);
                setTimes({ white: INITIAL_TIME, black: INITIAL_TIME });
                setFouls({ white: 0, black: 0 });
                setIsPaused(false);
            };

            const handleNameConfirm = () => {
                setIsNameSet(true);
            };

            const togglePause = () => {
                setIsPaused(!isPaused);
            };

            const getCurrentWhiteName = () => round === 1 ? p1Name : p2Name;
            const getCurrentBlackName = () => round === 1 ? p2Name : p1Name;

            const handleTimeOut = () => {
                const currentPieces = piecesRef.current;
                const whitePiecesLeft = currentPieces.filter(p => p.player === 'white');
                const blackPiecesLeft = currentPieces.filter(p => p.player === 'black');
                const whiteCapturedCount = 10 - whitePiecesLeft.length; 
                const blackCapturedCount = 10 - blackPiecesLeft.length; 

                const whiteScore = blackCapturedCount;
                const blackScore = whiteCapturedCount;

                if (whiteScore > blackScore) {
                    triggerWin('white', `â³ æ™‚é–“åˆ°ï¼ç™½è²“åƒæ‰ ${whiteScore} å­ï¼Œé»‘è²“åƒæ‰ ${blackScore} å­ã€‚`);
                } else if (blackScore > whiteScore) {
                    triggerWin('black', `â³ æ™‚é–“åˆ°ï¼é»‘è²“åƒæ‰ ${blackScore} å­ï¼Œç™½è²“åƒæ‰ ${whiteScore} å­ã€‚`);
                } else {
                    const whiteValuesLeft = whitePiecesLeft.map(p => p.value);
                    const blackValuesLeft = blackPiecesLeft.map(p => p.value);
                    const whiteCapturedValues = PIECE_VALUES.filter(v => !whiteValuesLeft.includes(v)); 
                    const blackCapturedValues = PIECE_VALUES.filter(v => !blackValuesLeft.includes(v)); 
                    const minWhiteAte = blackCapturedValues.length > 0 ? Math.min(...blackCapturedValues) : 999;
                    const minBlackAte = whiteCapturedValues.length > 0 ? Math.min(...whiteCapturedValues) : 999;

                    if (minWhiteAte < minBlackAte) {
                        triggerWin('white', `â³ å¹³æ‰‹ï¼ä½†åœ¨åƒæ‰çš„æ£‹å­ä¸­ï¼Œç™½è²“åƒäº†è¼ƒå°çš„æ•¸å­— (${minWhiteAte})ã€‚`);
                    } else if (minBlackAte < minWhiteAte) {
                        triggerWin('black', `â³ å¹³æ‰‹ï¼ä½†åœ¨åƒæ‰çš„æ£‹å­ä¸­ï¼Œé»‘è²“åƒäº†è¼ƒå°çš„æ•¸å­— (${minBlackAte})ã€‚`);
                    } else {
                         triggerWin('draw', "â³ æ™‚é–“åˆ°ï¼é›™æ–¹æˆ°ç¸¾å®Œå…¨ç›¸åŒï¼Œå¹³å±€ï¼");
                    }
                }
            };

            const getValidMoves = (piece, allPieces) => {
                if (!piece) return [];
                const moves = [];
                const currentPos = piece.position;
                const currentRow = Math.floor(currentPos / 10);
                let targetRow;

                if (!piece.isUpgraded) {
                    if (piece.player === 'white') targetRow = currentRow + 1;
                    else targetRow = currentRow - 1;
                } else {
                    if (piece.player === 'white') targetRow = currentRow - 1;
                    else targetRow = currentRow + 1;
                }

                if (targetRow < 0 || targetRow >= ROWS) return [];
                const startIdx = targetRow * 10;
                const endIdx = startIdx + 9;

                for (let i = startIdx; i <= endIdx; i++) {
                    const targetVal = i + 1; 
                    let isMathValid = false;
                    if (piece.isUpgraded) isMathValid = true;
                    else if (targetVal % piece.value === 0) isMathValid = true;

                    if (isMathValid) {
                        const occupant = allPieces.find(p => p.position === i);
                        if (!occupant) moves.push({ type: 'move', to: i });
                        else if (occupant.player !== piece.player) moves.push({ type: 'capture', to: i, capturedPiece: occupant });
                    }
                }
                return moves;
            };

            const handleSquareClick = (idx) => {
                if (roundWinner || matchOver || errorMsg || showRules || !isNameSet || isPaused) return; 
                const clickedPiece = pieces.find(p => p.position === idx);
                const isCurrentPlayerPiece = clickedPiece && clickedPiece.player === turn;

                if (isCurrentPlayerPiece) {
                    setSelectedPieceId(clickedPiece.id);
                    return;
                }
                if (selectedPieceId) {
                    const selectedPiece = pieces.find(p => p.id === selectedPieceId);
                    const validMoves = getValidMoves(selectedPiece, pieces);
                    const move = validMoves.find(m => m.to === idx);
                    if (move) executeMove(selectedPiece, move);
                    else handleInvalidMove(selectedPiece, idx);
                }
            };

            const handleInvalidMove = (piece, targetIdx) => {
                const targetRow = Math.floor(targetIdx / 10);
                const currentRow = Math.floor(piece.position / 10);
                const targetVal = targetIdx + 1;
                let reason = "ç„¡æ³•ç§»å‹•è‡³è©²è™•";
                const currentPlayerName = piece.player === 'white' ? getCurrentWhiteName() : getCurrentBlackName();
                
                if (!piece.isUpgraded) {
                    const expectedRow = piece.player === 'white' ? currentRow + 1 : currentRow - 1;
                    if (Math.abs(targetRow - currentRow) > 1 || targetRow !== expectedRow) reason = "è²“å’ªåªèƒ½å¾€å‰è·³ä¸€æ’ï¼";
                    else if (targetVal % piece.value !== 0) reason = `å–µï¼Ÿ ${targetVal} é™¤ä»¥ ${piece.value} ç„¡æ³•æ•´é™¤å–”ï¼`;
                }

                const newFouls = fouls[turn] + 1;
                setFouls(prev => ({ ...prev, [turn]: newFouls }));

                if (newFouls >= MAX_FOULS) {
                    triggerWin(turn === 'white' ? 'black' : 'white', "âŒ å°æ‰‹çŠ¯è¦æ»¿ 5 æ¬¡ï¼");
                    return;
                }

                setErrorMsg({
                    title: "è¸©åˆ°é™·é˜±å•¦ï¼",
                    detail: `${reason} (çŠ¯è¦ ${newFouls}/${MAX_FOULS})`
                });
                setHistory(prev => [`âŒ ${currentPlayerName}çŠ¯è¦ (${newFouls}/${MAX_FOULS})`, ...prev].slice(0, 10));

                if (errorTimeoutRef.current) clearTimeout(errorTimeoutRef.current);
                errorTimeoutRef.current = setTimeout(() => {
                    setErrorMsg(null);
                    setSelectedPieceId(null);
                    setTurn(prev => prev === 'white' ? 'black' : 'white');
                }, 2500);
            };

            const executeMove = (piece, move) => {
                let newPieces = pieces.filter(p => p.id !== piece.id);
                if (move.type === 'capture') newPieces = newPieces.filter(p => p.id !== move.capturedPiece.id);

                let justPromoted = false;
                let isUpgraded = piece.isUpgraded;
                if (!isUpgraded) {
                    const targetRow = Math.floor(move.to / 10);
                    if ((piece.player === 'white' && targetRow === 9) || (piece.player === 'black' && targetRow === 0)) {
                        isUpgraded = true;
                        justPromoted = true;
                    }
                }
                newPieces.push({ ...piece, position: move.to, isUpgraded: isUpgraded });
                setPieces(newPieces);
                
                const currentPlayerName = piece.player === 'white' ? getCurrentWhiteName() : getCurrentBlackName();
                const fromVal = piece.position + 1;
                const toVal = move.to + 1;
                const moveDesc = `${currentPlayerName} (${fromVal}â†’${toVal}) ${move.type === 'capture' ? 'æŠ“åˆ°äº†!' : ''} ${justPromoted ? 'è®Šèº«!' : ''}`;
                setHistory(prev => [moveDesc, ...prev].slice(0, 10));

                const nextTurn = turn === 'white' ? 'black' : 'white';
                checkWin(newPieces, nextTurn);
                setTurn(nextTurn);
                setSelectedPieceId(null);
            };

            const checkWin = (currentPieces, nextPlayer) => {
                const whiteCount = currentPieces.filter(p => p.player === 'white').length;
                const blackCount = currentPieces.filter(p => p.player === 'black').length;
                if (whiteCount === 0) triggerWin('black', "ğŸ† åƒå…‰æ‰€æœ‰å°æ‰‹ï¼");
                if (blackCount === 0) triggerWin('white', "ğŸ† åƒå…‰æ‰€æœ‰å°æ‰‹ï¼");
            };

            const triggerWin = (winnerColor, reason) => {
                setRoundWinner(winnerColor);
                setWinReason(reason);
                setIsPaused(false);
                
                let winnerId = null;
                if (winnerColor === 'white') {
                    winnerId = round === 1 ? 'p1' : 'p2';
                } else if (winnerColor === 'black') {
                    winnerId = round === 1 ? 'p2' : 'p1';
                }

                if (winnerId) {
                    setPlayerWins(prev => ({
                        ...prev,
                        [winnerId]: prev[winnerId] + 1
                    }));
                }

                confetti({
                    particleCount: 200,
                    spread: 100,
                    origin: { y: 0.6 },
                    shapes: ['circle', 'square'], 
                    colors: winnerColor === 'white' ? ['#ffaaaa', '#ffffff', '#ffdbac'] : ['#555555', '#000000', '#ffd700']
                });
            };

            const handleNextRound = () => {
                setRound(2);
                startRound();
            };

            const handleFinishMatch = () => {
                setMatchOver(true);
                setRoundWinner(null);
            };

            const resetMatch = () => {
                setIsNameSet(false);
                setP1Name("");
                setP2Name("");
                setPlayerWins({ p1: 0, p2: 0 });
                setMatchOver(false);
                setRound(1);
            };

            const getSquareColor = (idx) => {
                const row = Math.floor(idx / 10);
                const col = idx % 10;
                return (row + col) % 2 === 0 ? 'bg-orange-50/50' : 'bg-orange-100/50';
            };

            let matchResultText = "";
            let matchWinnerName = "";
            if (matchOver) {
                if (playerWins.p1 > playerWins.p2) {
                    matchWinnerName = p1Name;
                    matchResultText = "ç²å¾—æœ€çµ‚å‹åˆ©ï¼";
                } else if (playerWins.p2 > playerWins.p1) {
                    matchWinnerName = p2Name;
                    matchResultText = "ç²å¾—æœ€çµ‚å‹åˆ©ï¼";
                } else {
                    matchWinnerName = "å¹³æ‰‹";
                    matchResultText = "é›™æ–¹å¯¦åŠ›ç›¸ç•¶ï¼";
                }
            }

            return (
                <div className="min-h-screen flex flex-col md:flex-row items-center justify-center p-4 md:gap-8 relative overflow-hidden z-10">
                    
                    {!isNameSet && (
                        <NameInputModal 
                            whiteName={p1Name}
                            setWhiteName={setP1Name}
                            blackName={p2Name}
                            setBlackName={setP2Name}
                            onConfirm={handleNameConfirm}
                        />
                    )}

                    {showRules && <RulesModal onClose={() => setShowRules(false)} />}

                    {/* Round End Modal */}
                    {roundWinner && !matchOver && (
                        <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2rem] p-10 max-w-md w-full text-center shadow-2xl border-8 border-yellow-300 transform scale-100 animate-fade-in-pop relative">
                                <h2 className="text-3xl font-bold mb-2 font-serif text-stone-800">
                                    {roundWinner === 'draw' ? 'æœ¬å±€å¹³æ‰‹!' : `${roundWinner === 'white' ? getCurrentWhiteName() : getCurrentBlackName()} è´äº†ç¬¬ ${round} å›åˆ!`}
                                </h2>
                                <p className="text-lg text-orange-600 font-bold mb-6">{winReason}</p>
                                
                                {round === 1 ? (
                                    <div className="space-y-4">
                                        <p className="text-stone-500">æº–å‚™å¥½æ”»å®ˆäº¤æ›äº†å—ï¼Ÿ</p>
                                        <button onClick={handleNextRound} className="w-full px-8 py-4 bg-gradient-to-r from-blue-400 to-indigo-500 hover:from-blue-500 hover:to-indigo-600 text-white font-bold rounded-xl shadow-xl transition-transform hover:scale-105 text-lg flex items-center justify-center gap-2">
                                            <SwapIcon className="w-6 h-6"/>
                                            <span>äº¤æ›æ”»å®ˆï¼Œé€²å…¥ç¬¬ 2 å›åˆ</span>
                                        </button>
                                    </div>
                                ) : (
                                    <button onClick={handleFinishMatch} className="w-full px-8 py-4 bg-yellow-400 hover:bg-yellow-500 text-stone-900 font-bold rounded-xl shadow-xl transition-transform hover:scale-105 text-lg">
                                        è§€çœ‹æœ€çµ‚çµæœ ğŸ†
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Match Over Modal */}
                    {matchOver && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[2rem] p-12 max-w-lg w-full text-center shadow-2xl border-8 border-yellow-400 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-32 bg-yellow-100 -z-10 rounded-b-[50%]"></div>
                                <div className="text-8xl mb-4">ğŸ‘‘</div>
                                <h2 className="text-4xl font-bold mb-2 font-serif text-stone-800">æ¯”è³½çµæŸ</h2>
                                <div className="text-2xl font-bold text-orange-600 mb-8">
                                    {matchWinnerName} {matchResultText}
                                </div>
                                
                                <div className="flex justify-center gap-8 mb-8 text-stone-600">
                                    <div className="flex flex-col items-center">
                                        <span className="text-sm font-bold">{p1Name}</span>
                                        <span className="text-4xl font-bold">{playerWins.p1} å‹</span>
                                    </div>
                                    <div className="text-4xl font-light text-stone-300">VS</div>
                                    <div className="flex flex-col items-center">
                                        <span className="text-sm font-bold">{p2Name}</span>
                                        <span className="text-4xl font-bold">{playerWins.p2} å‹</span>
                                    </div>
                                </div>

                                <button onClick={resetMatch} className="px-10 py-4 bg-stone-800 hover:bg-stone-900 text-white font-bold rounded-full shadow-xl transition-transform hover:scale-105 text-lg">
                                    å›åˆ°é¦–é  / æ–°æ¯”è³½
                                </button>
                            </div>
                        </div>
                    )}

                    {errorMsg && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-stone-900/60 backdrop-blur-sm animate-fade-in-pop">
                            <div className="bg-white border-4 border-red-400 rounded-3xl p-8 max-w-md text-center shadow-2xl animate-shake relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-4 bg-red-400"></div>
                                <div className="text-6xl mb-4">ğŸ™€</div>
                                <h2 className="text-3xl font-bold text-red-600 mb-2">{errorMsg.title}</h2>
                                <p className="text-lg text-stone-700 font-bold mb-6">{errorMsg.detail}</p>
                                <div className="w-full h-3 bg-stone-200 rounded-full overflow-hidden">
                                    <div className="h-full bg-red-500 animate-[width_2.5s_linear_reverse_forwards]" style={{width: '100%'}}></div>
                                </div>
                                <p className="text-sm text-stone-400 mt-3 font-mono">æš«åœè¨ˆæ™‚ä¸­...</p>
                            </div>
                        </div>
                    )}

                    {/* Left Sidebar */}
                    <div className="flex flex-col gap-4 w-full md:w-72 order-2 md:order-1 z-10">
                        <div className="bg-white p-6 rounded-3xl shadow-xl border-4 border-blue-100 relative">
                            <div className="absolute -top-6 -left-4 text-6xl transform -rotate-12">ğŸ±</div>
                            <h1 className="text-3xl font-bold text-stone-800 mb-1 font-serif text-center">æ•¸æˆ°æ£‹</h1>
                            <div className="text-stone-400 text-xs text-center mb-6 tracking-widest font-bold bg-blue-100 inline-block px-2 py-1 rounded mx-auto block w-fit">
                                ROUND {round} / 2
                            </div>
                            
                            {/* Scoreboard */}
                            <div className="bg-blue-50 rounded-xl p-3 mb-4 border border-blue-100 flex flex-col gap-2">
                                <h3 className="text-center font-bold text-blue-800 flex items-center justify-center gap-2">
                                    <TrophyIcon className="w-5 h-5 text-yellow-500"/> ç¸½å‹å ´æ•¸
                                </h3>
                                <div className="flex justify-around items-center bg-white rounded-lg p-2 shadow-sm">
                                    <div className="flex flex-col items-center w-1/2 border-r border-blue-100">
                                        <span className="text-xs text-stone-500 truncate w-16 text-center">{p1Name}</span>
                                        <div className="text-3xl font-bold text-stone-700 leading-none">{playerWins.p1}</div>
                                    </div>
                                    <div className="flex flex-col items-center w-1/2">
                                        <span className="text-xs text-stone-500 truncate w-16 text-center">{p2Name}</span>
                                        <div className="text-3xl font-bold text-stone-700 leading-none">{playerWins.p2}</div>
                                    </div>
                                </div>
                            </div>

                            {/* Turn Indicator & Timer */}
                            <div className="space-y-3">
                                <div className={`p-3 rounded-2xl border-2 transition-all duration-300 flex items-center justify-between px-3 ${
                                    turn === 'white' ? 'bg-white border-blue-400 shadow-lg transform scale-105' : 'bg-stone-50 border-transparent opacity-60 grayscale'
                                }`}>
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-1">
                                            <div className="w-2 h-2 rounded-full bg-stone-300"></div>
                                            <span className="font-bold text-stone-800 text-sm truncate w-24">{getCurrentWhiteName()}</span>
                                        </div>
                                        <span className={`digital-font text-2xl font-bold ${times.white < 60 ? 'text-red-500 animate-pulse' : 'text-stone-600'}`}>
                                            {formatTime(times.white)}
                                        </span>
                                    </div>
                                    <div className="flex flex-col items-end">
                                        {turn === 'white' && <ClockIcon className="w-5 h-5 text-blue-400 animate-spin-slow mb-1"/>}
                                        <div className="flex items-center gap-1 bg-red-50 px-1.5 py-0.5 rounded text-[10px] text-red-500 font-bold">
                                            <AlertIcon className="w-3 h-3"/> {fouls.white}/{MAX_FOULS}
                                        </div>
                                    </div>
                                </div>
                                <div className={`p-3 rounded-2xl border-2 transition-all duration-300 flex items-center justify-between px-3 ${
                                    turn === 'black' ? 'bg-stone-800 border-yellow-400 shadow-lg transform scale-105' : 'bg-stone-100 border-transparent opacity-60 grayscale'
                                }`}>
                                    <div className="flex flex-col">
                                        <div className="flex items-center gap-1">
                                            <div className="w-2 h-2 rounded-full bg-stone-700"></div>
                                            <span className={`font-bold text-sm truncate w-24 ${turn === 'black' ? 'text-white' : 'text-stone-800'}`}>{getCurrentBlackName()}</span>
                                        </div>
                                        <span className={`digital-font text-2xl font-bold ${times.black < 60 ? 'text-red-500 animate-pulse' : (turn === 'black' ? 'text-white' : 'text-stone-600')}`}>
                                            {formatTime(times.black)}
                                        </span>
                                    </div>
                                    <div className="flex flex-col items-end">
                                        {turn === 'black' && <ClockIcon className="w-5 h-5 text-yellow-400 animate-spin-slow mb-1"/>}
                                        <div className="flex items-center gap-1 bg-red-50 px-1.5 py-0.5 rounded text-[10px] text-red-500 font-bold">
                                            <AlertIcon className="w-3 h-3"/> {fouls.black}/{MAX_FOULS}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button onClick={() => setShowRules(true)} className="w-full py-4 bg-white hover:bg-blue-50 text-blue-600 border-2 border-blue-200 rounded-2xl shadow-sm font-bold transition-all hover:scale-[1.02] flex items-center justify-center gap-3 group">
                            <BookIcon className="w-6 h-6 group-hover:rotate-12 transition-transform" />
                            <span>æŸ¥çœ‹è¦å‰‡æ‰‹å†Š</span>
                        </button>
                    </div>

                    {/* Main Board */}
                    <div className="order-1 md:order-2 relative select-none z-10">
                        <div className="wood-texture p-3 md:p-5 rounded-xl shadow-2xl relative">
                            <div className="grid grid-cols-10 gap-[2px] bg-stone-400/50 border-4 border-stone-700 rounded-sm overflow-hidden">
                                {Array.from({ length: 100 }).map((_, idx) => {
                                    const num = idx + 1;
                                    const piece = pieces.find(p => p.position === idx);
                                    const isSelected = selectedPieceId && piece && piece.id === selectedPieceId;
                                    const isWhiteHome = idx < 10;
                                    const isBlackHome = idx >= 90;

                                    return (
                                        <div key={idx} onClick={() => handleSquareClick(idx)} className={`w-8 h-8 md:w-12 md:h-12 flex items-center justify-center relative ${getSquareColor(idx)} ${isSelected ? 'bg-blue-200/60' : ''} cursor-pointer transition-colors hover:bg-white/40`}>
                                            <span className="absolute top-0.5 left-0.5 text-[8px] md:text-[9px] font-mono text-stone-400/70 select-none">{num}</span>
                                            {isWhiteHome && <div className="absolute bottom-0 w-full h-[2px] bg-red-300/40"></div>}
                                            {isBlackHome && <div className="absolute top-0 w-full h-[2px] bg-blue-300/40"></div>}
                                            {piece && (
                                                <div className={`w-[90%] h-[90%] md:w-[95%] md:h-[95%] relative flex items-center justify-center transition-all duration-200 ${isSelected ? 'scale-110 -translate-y-1 z-20 drop-shadow-xl' : 'hover:scale-105 z-10 drop-shadow-md'}`}>
                                                    <CatPieceSVG colorClass={piece.player === 'white' ? (piece.isUpgraded ? 'fill-red-50' : 'fill-white') : (piece.isUpgraded ? 'fill-red-900' : 'fill-stone-800')} strokeClass={piece.player === 'white'} />
                                                    <span className={`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-[40%] text-sm md:text-lg font-bold font-serif ${piece.isUpgraded ? 'text-red-500' : (piece.player === 'white' ? 'text-stone-800' : 'text-stone-200')}`}>{piece.value}</span>
                                                    {piece.isUpgraded && <div className="absolute bottom-1 right-1 text-[8px] md:text-[10px]">ğŸ‘‘</div>}
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    </div>

                    {/* Right Sidebar */}
                    <div className="flex flex-col gap-4 w-full md:w-64 order-3 h-full z-10">
                        <div className="bg-white p-4 rounded-3xl shadow-lg border border-blue-100 flex-1 min-h-[250px] flex flex-col">
                            <h3 className="font-bold text-stone-600 mb-3 text-sm border-b pb-2 flex items-center gap-2"><span>ğŸ“œ</span> æˆ°æ³è¨˜éŒ„</h3>
                            <div className="flex-1 overflow-y-auto pr-2 space-y-2">
                                {history.length === 0 ? (
                                    <div className="text-center text-stone-400 text-sm py-8 flex flex-col items-center gap-2"><span className="text-2xl opacity-50">ğŸ¾</span><p>æˆ°é¬¥æº–å‚™ä¸­...</p></div>
                                ) : (
                                    history.map((log, i) => (
                                        <div key={i} className="flex items-center gap-2 text-xs md:text-sm p-2 rounded-lg bg-stone-50 border border-stone-100 animate-fade-in-pop">
                                            <span className="text-blue-300 font-mono">{history.length - i}.</span><span className="text-stone-600">{log}</span>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                        <button onClick={resetMatch} className="w-full py-3 bg-stone-700 hover:bg-stone-800 text-white rounded-2xl shadow-lg font-bold transition-all active:scale-95 flex items-center justify-center gap-2"><span>ğŸ”„ çµæŸæ¯”è³½ / é‡æ–°é–‹å§‹</span></button>
                    </div>

                    {/* Pause Button - Bottom Right Floating */}
                    <button 
                        onClick={togglePause}
                        className={`fixed bottom-6 right-6 z-[60] w-16 h-16 rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 transform hover:scale-110 active:scale-95 ${
                            isPaused 
                                ? 'bg-green-500 text-white hover:bg-green-600 border-4 border-white' 
                                : 'bg-yellow-400 text-stone-900 hover:bg-yellow-500 border-4 border-white'
                        }`}
                        title={isPaused ? "ç¹¼çºŒéŠæˆ²" : "æš«åœéŠæˆ²"}
                    >
                        {isPaused ? <PlayIcon className="w-8 h-8 ml-1"/> : <PauseIcon className="w-8 h-8"/>}
                    </button>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>